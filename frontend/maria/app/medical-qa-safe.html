<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Q&A with Safety - MARIA</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .qa-container { max-width: 1400px; margin: 0 auto; }
        .qa-layout { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
        .sidebar-panel { background: white; border-radius: var(--sarah-border-radius-lg); padding: 24px; box-shadow: var(--sarah-shadow-md); height: fit-content; }
        .chat-panel { background: white; border-radius: var(--sarah-border-radius-lg); box-shadow: var(--sarah-shadow-md); display: flex; flex-direction: column; height: 700px; }
        .chat-header { padding: 24px; border-bottom: 2px solid var(--sarah-border-color); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 24px; background: var(--sarah-bg-secondary); }
        .message { margin-bottom: 16px; padding: 16px; border-radius: var(--sarah-border-radius); max-width: 85%; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, var(--sarah-primary), var(--sarah-medical-teal)); color: white; margin-left: auto; }
        .message.assistant { background: white; border: 2px solid var(--sarah-border-color); }
        .message-header { font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; }

        /* Safety Indicators */
        .safety-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .safety-low { background: rgba(16, 185, 129, 0.15); color: var(--sarah-success); border: 2px solid var(--sarah-success); }
        .safety-moderate { background: rgba(245, 158, 11, 0.15); color: var(--sarah-warning); border: 2px solid var(--sarah-warning); }
        .safety-high { background: rgba(239, 68, 68, 0.15); color: var(--sarah-error); border: 2px solid var(--sarah-error); }
        .safety-critical { background: rgba(220, 38, 38, 0.2); color: #dc2626; border: 2px solid #dc2626; animation: pulse 2s infinite; }

        .safety-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--sarah-border-radius-sm);
            border-left: 4px solid;
        }
        .safety-box.low { background: rgba(16, 185, 129, 0.05); border-color: var(--sarah-success); }
        .safety-box.moderate { background: rgba(245, 158, 11, 0.05); border-color: var(--sarah-warning); }
        .safety-box.high { background: rgba(239, 68, 68, 0.05); border-color: var(--sarah-error); }
        .safety-box.critical { background: rgba(220, 38, 38, 0.1); border-color: #dc2626; animation: emergencyPulse 1.5s infinite; }

        @keyframes emergencyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        .warning-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .disclaimer-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255,255,255,0.5);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .triplet-box { background: var(--sarah-bg-light); padding: 12px; border-radius: 8px; margin-top: 12px; font-family: monospace; font-size: 0.85rem; }
        .triplet-item { padding: 6px; background: white; border-radius: 4px; margin: 4px 0; }
        .confidence-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; }
        .conf-high { background: var(--sarah-success); color: white; }
        .conf-medium { background: var(--sarah-warning); color: white; }
        .conf-low { background: var(--sarah-error); color: white; }
        .chat-input-area { padding: 20px; border-top: 2px solid var(--sarah-border-color); display: flex; gap: 12px; }
        .chat-input-area textarea { flex: 1; padding: 12px; border: 2px solid var(--sarah-border-color); border-radius: var(--sarah-border-radius); resize: none; font-family: inherit; }
        .template-btn { padding: 10px 16px; background: var(--sarah-bg-light); border: 2px solid var(--sarah-border-color); border-radius: var(--sarah-border-radius); cursor: pointer; text-align: left; transition: all 0.2s; margin-bottom: 8px; width: 100%; }
        .template-btn:hover { border-color: var(--sarah-primary); background: white; }
        .loading { display: flex; gap: 5px; padding: 10px; }
        .loading-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--sarah-primary); animation: bounce 1.4s infinite ease-in-out; }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--sarah-bg-secondary);
            border-radius: var(--sarah-border-radius);
        }
        .mode-btn {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid transparent;
            background: transparent;
            border-radius: var(--sarah-border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: white;
            border-color: var(--sarah-primary);
            color: var(--sarah-primary);
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header"><i class="fas fa-stethoscope"></i><span>MARIA</span></div>
            <nav><ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="medical-qa-safe.html" class="active"><i class="fas fa-question-circle"></i> Medical Q&A</a></li>
                <li><a href="drug-checker.html"><i class="fas fa-pills"></i> Drug Checker</a></li>
                <li><a href="clinical-support.html"><i class="fas fa-clipboard-check"></i> Clinical Support</a></li>
                <li><a href="patient-analysis.html"><i class="fas fa-user-md"></i> Patient Analysis</a></li>
                <li><a href="knowledge-graph.html"><i class="fas fa-project-diagram"></i> Knowledge Graph</a></li>
                <li><a href="literature.html"><i class="fas fa-book-medical"></i> Literature</a></li>
                <li><a href="safety-dashboard.html"><i class="fas fa-shield-alt"></i> Safety Dashboard</a></li>
                <li><a href="data-integration.html"><i class="fas fa-database"></i> Data Integration</a></li>
            </ul></nav>
            <div class="sidebar-footer">
                <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
                <a href="training.html"><i class="fas fa-graduation-cap"></i> Training</a>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-question-circle"></i> Medical Q&A
                    <span class="sarah-badge sarah-badge-success" style="font-size: 0.6rem; vertical-align: middle;">
                        <i class="fas fa-shield-alt"></i> Safety Validated
                    </span>
                </h1>
                <p class="page-subtitle">AI-powered medical question answering with KGAREVION pipeline and safety validation</p>
            </div>

            <div class="qa-layout">
                <!-- Sidebar with templates -->
                <div class="sidebar-panel">
                    <h3 style="margin-bottom: 16px;"><i class="fas fa-clipboard-list"></i> Mode Selection</h3>

                    <div class="mode-toggle">
                        <button class="mode-btn active" onclick="selectMode('kgarevion')" id="mode-kgarevion">
                            <i class="fas fa-brain"></i> KGAREVION
                        </button>
                        <button class="mode-btn" onclick="selectMode('standard')" id="mode-standard">
                            <i class="fas fa-comment"></i> Standard
                        </button>
                    </div>

                    <p style="font-size: 0.85rem; color: var(--sarah-text-secondary); margin-bottom: 1rem;">
                        KGAREVION mode includes full safety validation and knowledge graph verification
                    </p>

                    <h3 style="margin-bottom: 16px; margin-top: 2rem;"><i class="fas fa-file-medical"></i> Example Questions</h3>
                    <button class="template-btn" onclick="useTemplate('Which protein is associated with Retinitis Pigmentosa 59?')">
                        Protein-disease association
                    </button>
                    <button class="template-btn" onclick="useTemplate('What are the drug interactions between warfarin and aspirin?')">
                        Drug interactions
                    </button>
                    <button class="template-btn" onclick="useTemplate('What is the first-line treatment for type 2 diabetes?')">
                        Treatment recommendations
                    </button>
                    <button class="template-btn" onclick="useTemplate('What are the side effects of metformin?')">
                        Drug side effects
                    </button>
                </div>

                <!-- Chat area -->
                <div class="chat-panel">
                    <div class="chat-header">
                        <h2 style="margin: 0;"><i class="fas fa-comments"></i> Conversation</h2>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--sarah-text-secondary);">Ask medical questions and get AI-powered answers</p>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-header">MARIA</div>
                            <div>
                                <p>👋 Hello! I'm MARIA, your AI medical research assistant.</p>
                                <p>I use the KGAREVION pipeline to provide knowledge graph-verified answers with comprehensive safety validation.</p>
                                <p><strong>Safety Features:</strong></p>
                                <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                    <li>🚨 Emergency condition detection</li>
                                    <li>💊 Drug interaction checking</li>
                                    <li>👶 Protected population screening</li>
                                    <li>⚕️ Risk level assessment</li>
                                </ul>
                                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                                    ℹ️ Select an example question or type your own medical question below.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <textarea id="questionInput" placeholder="Type your medical question here..." rows="3"></textarea>
                        <button class="sarah-btn sarah-btn-primary" onclick="sendQuestion()" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/dr-sarah';
        let currentMode = 'kgarevion';

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('mode-kgarevion').classList.toggle('active', mode === 'kgarevion');
            document.getElementById('mode-standard').classList.toggle('active', mode === 'standard');
        }

        function useTemplate(text) {
            document.getElementById('questionInput').value = text;
            document.getElementById('questionInput').focus();
        }

        document.getElementById('questionInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuestion(); }
        });

        async function sendQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) return;

            addMessage('user', question);
            document.getElementById('questionInput').value = '';
            document.getElementById('sendBtn').disabled = true;

            const loadingId = addLoadingMessage();

            try {
                const endpoint = currentMode === 'kgarevion' ? '/kgarevion' : '/medical-qa';
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question, include_triplets: true, include_entities: true})
                });
                const data = await res.json();
                removeMessage(loadingId);
                addAnswerMessage(data);
            } catch (error) {
                removeMessage(loadingId);
                addMessage('assistant', `❌ Error: ${error.message}`);
            } finally {
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<div class="message-header">${role === 'user' ? 'You' : 'MARIA'}</div><div>${content}</div>`;
            document.getElementById('chatMessages').appendChild(div);
            div.scrollIntoView({behavior: 'smooth'});
        }

        function addLoadingMessage() {
            const div = document.createElement('div');
            const id = 'loading-' + Date.now();
            div.id = id;
            div.className = 'message assistant';
            div.innerHTML = '<div class="message-header">MARIA</div><div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
            document.getElementById('chatMessages').appendChild(div);
            return id;
        }

        function removeMessage(id) {
            document.getElementById(id)?.remove();
        }

        function addAnswerMessage(data) {
            const conf = data.confidence || data.confidence_score || 0;
            const confClass = conf > 0.8 ? 'conf-high' : conf > 0.5 ? 'conf-medium' : 'conf-low';

            // Build answer HTML
            let html = `<div class="message-header">`;
            html += `MARIA`;
            html += `<span class="confidence-badge ${confClass}">${Math.round(conf*100)}% confidence</span>`;

            // Add safety indicator if present
            if (data.safety) {
                const safety = data.safety;
                const safetyClass = `safety-${safety.risk_level}`;
                const safetyIcon = {
                    'low': 'fa-check-circle',
                    'moderate': 'fa-exclamation-circle',
                    'high': 'fa-exclamation-triangle',
                    'critical': 'fa-ambulance'
                }[safety.risk_level] || 'fa-info-circle';

                html += `<span class="safety-indicator ${safetyClass}">
                    <i class="fas ${safetyIcon}"></i>
                    ${safety.risk_level} risk
                </span>`;
            }
            html += `</div>`;

            // Answer content
            html += `<div><strong>Answer:</strong><div style="margin-top: 0.5rem;">${data.answer}</div>`;

            // Safety information
            if (data.safety) {
                const safety = data.safety;
                html += `<div class="safety-box ${safety.risk_level}" style="margin-top: 1rem;">`;
                html += `<div style="font-weight: 700; margin-bottom: 0.5rem;">
                    <i class="fas fa-shield-alt"></i> Safety Assessment
                </div>`;
                html += `<div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                    <strong>Domain:</strong> ${safety.domain}
                </div>`;

                if (safety.warnings && safety.warnings.length > 0) {
                    html += `<div style="margin-top: 0.75rem;"><strong style="color: var(--sarah-warning);">
                        <i class="fas fa-exclamation-triangle"></i> Warnings:
                    </strong></div>`;
                    safety.warnings.forEach(w => {
                        html += `<div class="warning-item"><i class="fas fa-exclamation-circle"></i> ${w}</div>`;
                    });
                }

                if (safety.disclaimers && safety.disclaimers.length > 0) {
                    html += `<div style="margin-top: 0.75rem;"><strong><i class="fas fa-info-circle"></i> Important:</strong></div>`;
                    safety.disclaimers.forEach(d => {
                        html += `<div class="disclaimer-item">${d}</div>`;
                    });
                }

                if (safety.requires_human_review) {
                    html += `<div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; font-weight: 600;">
                        <i class="fas fa-user-md"></i> This response requires human medical review
                    </div>`;
                }

                html += `</div>`;
            }

            // Knowledge triplets
            if (data.verified_triplets && data.verified_triplets.length > 0) {
                html += `<div class="triplet-box">
                    <strong><i class="fas fa-project-diagram"></i> Knowledge Triplets (${data.verified_triplets.length}):</strong>`;
                data.verified_triplets.slice(0, 5).forEach(t => {
                    html += `<div class="triplet-item">${t.head} → <em>${t.relation}</em> → ${t.tail}
                        <span style="color: #666; font-size: 0.8rem;">(${Math.round(t.confidence*100)}%)</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Medical entities
            if (data.medical_entities && data.medical_entities.length > 0) {
                html += `<div style="margin-top:10px;font-size:0.85rem;color:#666;">
                    <strong><i class="fas fa-tags"></i> Entities:</strong> ${data.medical_entities.join(', ')}
                </div>`;
            }

            // Processing stats
            if (data.processing_stats) {
                html += `<div style="margin-top:10px;font-size:0.8rem;color:#999;">
                    ⚡ Processed in ${data.processing_stats.processing_time_ms}ms |
                    ${data.processing_stats.triplets_verified} triplets verified
                </div>`;
            }

            html += `</div>`;

            const div = document.createElement('div');
            div.className = 'message assistant';
            div.innerHTML = html;
            document.getElementById('chatMessages').appendChild(div);
            div.scrollIntoView({behavior: 'smooth'});
        }
    </script>
</body>
</html>
